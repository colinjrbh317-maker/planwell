---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { articles } from '../../../data/articles';
import { getAuthor } from '../../../data/authors';

// Topic definitions
const topics = {
  'tsp': {
    name: 'TSP & Investing',
    description: 'Thrift Savings Plan strategies, G Fund rates, withdrawal options, and investment guidance for federal employees.',
    icon: 'üìà',
    keywords: ['tsp', 'thrift savings', 'g fund', 'c fund', 's fund', 'i fund', 'f fund', 'l fund', 'investment', 'withdrawal', 'roth']
  },
  'fers': {
    name: 'FERS Pension',
    description: 'Federal Employees Retirement System calculations, annuity supplements, MRA, and retirement eligibility.',
    icon: 'üèõÔ∏è',
    keywords: ['fers', 'annuity', 'pension', 'retirement', 'supplement', 'mra', 'creditable service', 'high-3', 'cola']
  },
  'health': {
    name: 'Health Benefits',
    description: 'FEHB plan selection, Medicare coordination, dental and vision benefits, and open season guidance.',
    icon: 'üè•',
    keywords: ['fehb', 'medicare', 'health', 'insurance', 'dental', 'vision', 'fedvip', 'fltcip', 'open season']
  },
  'pay': {
    name: 'Pay & Compensation',
    description: 'Federal pay raises, GS pay scale, locality adjustments, COLA updates, and military pay charts.',
    icon: 'üí∞',
    keywords: ['pay raise', 'gs pay', 'locality', 'cola', 'salary', 'military pay', 'compensation', 'wage']
  }
};

export function getStaticPaths() {
  return Object.keys(topics).map(slug => ({ params: { slug } }));
}

const { slug } = Astro.params;
const topic = topics[slug];

if (!topic) {
  return Astro.redirect('/blog');
}

// Get all articles and filter by topic keywords
const allArticles = Object.entries(articles).map(([articleSlug, article]) => ({
  ...article,
  slug: articleSlug,
  authorData: getAuthor(article.author)
}));

// Filter articles that match any of the topic keywords
const topicArticles = allArticles.filter(article => {
  const searchText = `${article.title} ${article.excerpt || ''} ${article.category || ''}`.toLowerCase();
  return topic.keywords.some(keyword => searchText.includes(keyword.toLowerCase()));
});

// Prepare for client-side
const articlesForClient = topicArticles.map(a => ({
  slug: a.slug,
  title: a.title,
  excerpt: a.excerpt?.slice(0, 150) || '',
  category: a.category || 'FERS',
  date: a.date,
  authorName: a.authorData?.name || 'PlanWell Team',
  authorImage: a.authorData?.image || '/images/authors/planwell-team.jpg',
  authorCreds: a.authorData?.credentials || '',
  image: a.image || '/images/blog/default-cover.jpg',
}));
---

<BaseLayout
  title={`${topic.name} Articles | PlanWell Blog`}
  description={topic.description}
>
  <!-- Hero -->
  <section class="topic-hero">
    <div class="container">
      <a href="/blog" class="back-link">‚Üê Back to all articles</a>
      <span class="topic-icon">{topic.icon}</span>
      <h1 class="topic-hero__title">{topic.name}</h1>
      <p class="topic-hero__desc">{topic.description}</p>
      <p class="topic-hero__count">{topicArticles.length} articles</p>
    </div>
  </section>

  <!-- Search -->
  <section class="search-section">
    <div class="container">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input
          type="search"
          id="search-input"
          placeholder={`Search ${topic.name.toLowerCase()} articles...`}
          class="search-input"
        />
      </div>
      <div class="results-info" id="results-info">
        Showing all {topicArticles.length} articles
      </div>
    </div>
  </section>

  <!-- Articles -->
  <section class="articles-section">
    <div class="container">
      <div class="articles-grid" id="articles-grid">
        <!-- Rendered by JS -->
      </div>

      <div class="load-more-wrapper" id="load-more-wrapper" style="display: none;">
        <button id="load-more-btn" class="btn btn--secondary btn--lg">
          Load More Articles
        </button>
      </div>
    </div>
  </section>

  <!-- Other Topics -->
  <section class="other-topics">
    <div class="container">
      <h2>Explore Other Topics</h2>
      <div class="topics-grid">
        {Object.entries(topics).filter(([s]) => s !== slug).map(([s, t]) => (
          <a href={`/blog/topic/${s}`} class="topic-card">
            <span class="topic-card__icon">{t.icon}</span>
            <h3 class="topic-card__title">{t.name}</h3>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="bottom-cta">
    <div class="container">
      <div class="bottom-cta__content">
        <h2>Have Questions About {topic.name}?</h2>
        <p>Our certified planners specialize in federal employee benefits. Get personalized guidance in our free workshop.</p>
        <a href="/webinar" class="btn btn--primary btn--lg">Reserve My Free Seat</a>
      </div>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ articlesForClient }}>
  let allArticles = articlesForClient;
  let filteredArticles = [...allArticles];
  let displayedCount = 0;
  const ARTICLES_PER_PAGE = 12;

  const searchInput = document.getElementById('search-input');
  const articlesGrid = document.getElementById('articles-grid');
  const resultsInfo = document.getElementById('results-info');
  const loadMoreWrapper = document.getElementById('load-more-wrapper');
  const loadMoreBtn = document.getElementById('load-more-btn');

  function createArticleCard(article) {
    return `
      <article class="post-card">
        <a href="/blog/${article.slug}" class="post-card__image-link">
          <img src="${article.image}" alt="${article.title}" class="post-card__image" loading="lazy"
               onerror="this.onerror=null; this.src='/images/blog/default-cover.jpg';" />
        </a>
        <div class="post-card__content">
          <div class="post-card__meta-top">
            <span class="post-card__category">${article.category}</span>
            <span class="post-card__date">${article.date}</span>
          </div>
          <h3 class="post-card__title">
            <a href="/blog/${article.slug}">${article.title}</a>
          </h3>
          <div class="post-card__author">
            <img src="${article.authorImage}" alt="${article.authorName}" class="post-card__author-image" />
            <span class="post-card__author-name">${article.authorName}</span>
          </div>
        </div>
      </article>
    `;
  }

  function filterAndRender() {
    const searchTerm = searchInput.value.toLowerCase().trim();

    filteredArticles = allArticles.filter(article => {
      if (!searchTerm) return true;
      return article.title.toLowerCase().includes(searchTerm) ||
             article.excerpt.toLowerCase().includes(searchTerm);
    });

    resultsInfo.textContent = searchTerm
      ? `Found ${filteredArticles.length} articles matching "${searchTerm}"`
      : `Showing all ${filteredArticles.length} articles`;

    displayedCount = 0;
    articlesGrid.innerHTML = '';
    loadMoreArticles();
  }

  function loadMoreArticles() {
    const nextBatch = filteredArticles.slice(displayedCount, displayedCount + ARTICLES_PER_PAGE);
    nextBatch.forEach(article => {
      articlesGrid.innerHTML += createArticleCard(article);
    });
    displayedCount += nextBatch.length;

    const remaining = filteredArticles.length - displayedCount;
    if (remaining > 0) {
      loadMoreWrapper.style.display = 'block';
      loadMoreBtn.textContent = `Load More Articles (${remaining} remaining)`;
    } else {
      loadMoreWrapper.style.display = 'none';
    }
  }

  searchInput.addEventListener('input', filterAndRender);
  loadMoreBtn.addEventListener('click', loadMoreArticles);
  filterAndRender();
</script>

<style>
  .topic-hero {
    background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-navy-dark) 100%);
    color: var(--color-white);
    padding: var(--space-10) 0;
    text-align: center;
  }

  .back-link {
    display: inline-block;
    color: var(--color-gray-300);
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
  }

  .back-link:hover {
    color: var(--color-white);
  }

  .topic-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: var(--space-4);
  }

  .topic-hero__title {
    color: var(--color-white);
    font-size: var(--text-4xl);
    margin-bottom: var(--space-3);
  }

  .topic-hero__desc {
    color: var(--color-gray-300);
    max-width: 600px;
    margin: 0 auto var(--space-4);
  }

  .topic-hero__count {
    color: var(--color-gold);
    font-weight: var(--font-semibold);
  }

  .search-section {
    background: var(--color-white);
    padding: var(--space-6) 0;
    border-bottom: 1px solid var(--color-gray-100);
  }

  .search-box {
    display: flex;
    align-items: center;
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: var(--space-2) var(--space-4);
    max-width: 500px;
    margin: 0 auto var(--space-4);
  }

  .search-icon {
    color: var(--color-gray-400);
    margin-right: var(--space-3);
  }

  .search-input {
    flex: 1;
    border: none;
    background: transparent;
    padding: var(--space-2) 0;
    font-size: var(--text-base);
    outline: none;
  }

  .results-info {
    text-align: center;
    font-size: var(--text-sm);
    color: var(--color-gray-500);
  }

  .articles-section {
    background: var(--color-gray-50);
    padding: var(--space-10) 0;
  }

  .articles-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-6);
  }

  .post-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
  }

  .post-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .post-card__image-link {
    display: block;
    aspect-ratio: 16/10;
    overflow: hidden;
  }

  .post-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-card__content {
    padding: var(--space-5);
  }

  .post-card__meta-top {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--space-2);
  }

  .post-card__category {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    color: var(--color-gold);
  }

  .post-card__date {
    font-size: var(--text-xs);
    color: var(--color-gray-500);
  }

  .post-card__title {
    font-size: var(--text-lg);
    margin-bottom: var(--space-3);
    line-height: 1.3;
  }

  .post-card__title a {
    color: var(--color-navy);
  }

  .post-card__title a:hover {
    color: var(--color-gold);
  }

  .post-card__author {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-gray-100);
  }

  .post-card__author-image {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
  }

  .post-card__author-name {
    font-size: var(--text-sm);
    color: var(--color-navy);
  }

  .load-more-wrapper {
    text-align: center;
    margin-top: var(--space-10);
  }

  .other-topics {
    padding: var(--space-12) 0;
    background: var(--color-white);
  }

  .other-topics h2 {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .topics-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-6);
    max-width: 800px;
    margin: 0 auto;
  }

  .topic-card {
    background: var(--color-gray-50);
    border: 2px solid var(--color-gray-100);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    text-align: center;
    transition: all var(--transition-base);
  }

  .topic-card:hover {
    border-color: var(--color-gold);
    transform: translateY(-2px);
  }

  .topic-card__icon {
    font-size: 2rem;
    display: block;
    margin-bottom: var(--space-2);
  }

  .topic-card__title {
    font-size: var(--text-base);
    color: var(--color-navy);
  }

  .bottom-cta {
    background: var(--color-navy);
    padding: var(--space-12) 0;
    text-align: center;
  }

  .bottom-cta__content {
    max-width: 600px;
    margin: 0 auto;
  }

  .bottom-cta__content h2 {
    color: var(--color-white);
    margin-bottom: var(--space-3);
  }

  .bottom-cta__content p {
    color: var(--color-gray-300);
    margin-bottom: var(--space-6);
  }

  @media (max-width: 1024px) {
    .articles-grid, .topics-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .articles-grid, .topics-grid {
      grid-template-columns: 1fr;
    }

    .topic-hero__title {
      font-size: var(--text-3xl);
    }
  }
</style>
