---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { articles } from '../../data/articles';
import { authors, getAllAuthors, getAuthor } from '../../data/authors';

// Get all articles as array with proper author lookup
const allArticles = Object.entries(articles).map(([slug, article]) => ({
  ...article,
  slug,
  authorData: getAuthor(article.author)
}));

// Authors with article counts
const blogAuthors = getAllAuthors().filter(a => a.credentials).map(author => ({
  ...author,
  articleCount: allArticles.filter(a => a.author === author.slug).length
}));

// Featured/Trending topics - curated list of what's most relevant now
const featuredTopics = [
  { name: "TSP & Investing", slug: "tsp", icon: "ðŸ“ˆ", desc: "G Fund rates, TSP strategies, withdrawal options" },
  { name: "FERS Pension", slug: "fers", icon: "ðŸ›ï¸", desc: "Annuity calculations, supplements, retirement dates" },
  { name: "Health Benefits", slug: "health", icon: "ðŸ¥", desc: "FEHB, Medicare coordination, open season" },
  { name: "Pay & Compensation", slug: "pay", icon: "ðŸ’°", desc: "Pay raises, COLA, locality adjustments" },
];

// Prepare articles data for client-side use (minimal data to reduce page size)
const articlesForClient = allArticles.map(a => ({
  slug: a.slug,
  title: a.title,
  excerpt: a.excerpt?.slice(0, 150) || '',
  category: a.category || 'FERS',
  date: a.date,
  author: a.author,
  authorName: a.authorData?.name || 'PlanWell Team',
  authorImage: a.authorData?.image || '/images/authors/planwell-team.jpg',
  authorCreds: a.authorData?.credentials || '',
  image: a.image || '/images/blog/default-cover.jpg',
}));
---

<BaseLayout
  title="Federal Retirement Blog | PlanWell Financial Planning"
  description="Expert articles on FERS pension, TSP investing, FEHB health insurance, and federal employee benefits from certified financial planners."
>
  <!-- Hero Section -->
  <section class="blog-hero">
    <div class="container">
      <h1 class="blog-hero__title">Federal Retirement Resources</h1>
      <p class="blog-hero__subtitle">
        {allArticles.length} articles from our certified federal benefits specialists
      </p>

      <!-- Search Bar -->
      <div class="search-wrapper">
        <div class="search-box">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <input
            type="search"
            id="search-input"
            placeholder="Search for topics like 'FERS supplement', 'TSP withdrawal', 'Medicare'..."
            class="search-input"
          />
          <button id="clear-search" class="clear-btn" style="display: none;">Ã—</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Topic Cards -->
  <section class="topics-section">
    <div class="container">
      <h2 class="section-title">Explore by Topic</h2>
      <div class="topics-grid">
        {featuredTopics.map(topic => (
          <a href={`/blog/topic/${topic.slug}`} class="topic-card">
            <span class="topic-card__icon">{topic.icon}</span>
            <h3 class="topic-card__title">{topic.name}</h3>
            <p class="topic-card__desc">{topic.desc}</p>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Filter Bar -->
  <section class="filter-section">
    <div class="container">
      <div class="filter-bar">
        <div class="filter-group">
          <span class="filter-label">Filter by author:</span>
          <div class="author-filters" id="author-filters">
            <button class="author-btn author-btn--active" data-author="all">All</button>
            {blogAuthors.map(author => (
              <button class="author-btn" data-author={author.slug}>
                <img src={author.image} alt={author.name} class="author-btn__img" />
                {author.name.split(' ')[0]}
              </button>
            ))}
          </div>
        </div>
        <div class="results-info" id="results-info">
          Showing all {allArticles.length} articles
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="blog-main">
    <div class="container">
      <!-- Articles Grid -->
      <div class="articles-grid" id="articles-grid">
        <!-- Articles will be rendered by JavaScript -->
      </div>

      <!-- Newsletter Signup (mid-page) -->
      <div class="newsletter-inline" id="newsletter-section">
        <div class="newsletter-inline__content">
          <div class="newsletter-inline__text">
            <h3>Get Federal Benefits Updates</h3>
            <p>Join thousands of federal employees who get our weekly insights on FERS, TSP, and retirement planning.</p>
          </div>
          <form class="newsletter-inline__form" id="newsletter-form">
            <input type="email" id="newsletter-email" placeholder="Enter your email" required />
            <button type="submit" class="btn btn--gold">Subscribe</button>
          </form>
          <p class="newsletter-inline__note" id="newsletter-status">No spam. Unsubscribe anytime.</p>
        </div>
      </div>

      <!-- More Articles -->
      <div class="articles-grid articles-grid--continued" id="articles-grid-continued">
        <!-- More articles rendered by JavaScript -->
      </div>

      <!-- Load More -->
      <div class="load-more-wrapper" id="load-more-wrapper">
        <button id="load-more-btn" class="btn btn--secondary btn--lg">
          Load More Articles
        </button>
      </div>
    </div>
  </section>

  <!-- Meet the Team -->
  <section class="team-section">
    <div class="container">
      <h2 class="section-title">Written by Federal Benefits Experts</h2>
      <div class="team-grid">
        {blogAuthors.map(author => (
          <button class="team-card" data-filter-author={author.slug}>
            <img src={author.image} alt={author.name} class="team-card__image" />
            <div class="team-card__info">
              <h3 class="team-card__name">{author.name}</h3>
              <span class="team-card__creds">{author.credentials}</span>
              <span class="team-card__count">{author.articleCount} articles</span>
            </div>
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Bottom CTA -->
  <section class="bottom-cta">
    <div class="container">
      <div class="bottom-cta__content">
        <span class="bottom-cta__badge">Free Workshop</span>
        <h2>Master Your Federal Retirement in 3 Hours</h2>
        <p>Join 10,000+ federal employees who've attended our comprehensive FERS workshop. Live Q&A with certified planners, no sales pitch.</p>
        <a href="/webinar" class="btn btn--primary btn--lg">Reserve My Free Seat</a>
      </div>
    </div>
  </section>
</BaseLayout>

<script define:vars={{ articlesForClient, blogAuthors }}>
  // State
  let allArticles = articlesForClient;
  let filteredArticles = [...allArticles];
  let currentAuthor = 'all';
  let currentSearch = '';
  let displayedCount = 0;
  const ARTICLES_PER_PAGE = 12;
  const NEWSLETTER_POSITION = 6; // Show newsletter after 6 articles

  // DOM Elements
  const searchInput = document.getElementById('search-input');
  const clearBtn = document.getElementById('clear-search');
  const articlesGrid = document.getElementById('articles-grid');
  const articlesGridContinued = document.getElementById('articles-grid-continued');
  const resultsInfo = document.getElementById('results-info');
  const loadMoreWrapper = document.getElementById('load-more-wrapper');
  const loadMoreBtn = document.getElementById('load-more-btn');
  const authorFilters = document.getElementById('author-filters');
  const newsletterForm = document.getElementById('newsletter-form');
  const newsletterEmail = document.getElementById('newsletter-email');
  const newsletterStatus = document.getElementById('newsletter-status');
  const teamCards = document.querySelectorAll('.team-card');

  // Create article HTML
  function createArticleCard(article) {
    return `
      <article class="post-card">
        <a href="/blog/${article.slug}" class="post-card__image-link">
          <img
            src="${article.image}"
            alt="${article.title}"
            class="post-card__image"
            loading="lazy"
            onerror="this.onerror=null; this.src='/images/blog/default-cover.jpg';"
          />
        </a>
        <div class="post-card__content">
          <div class="post-card__meta-top">
            <span class="post-card__category">${article.category}</span>
            <span class="post-card__date">${article.date}</span>
          </div>
          <h3 class="post-card__title">
            <a href="/blog/${article.slug}">${article.title}</a>
          </h3>
          <div class="post-card__author">
            <img src="${article.authorImage}" alt="${article.authorName}" class="post-card__author-image" />
            <span class="post-card__author-name">${article.authorName}</span>
            ${article.authorCreds ? `<span class="post-card__author-creds">${article.authorCreds}</span>` : ''}
          </div>
        </div>
      </article>
    `;
  }

  // Filter and render articles
  function filterAndRender() {
    // Apply filters
    filteredArticles = allArticles.filter(article => {
      const matchesAuthor = currentAuthor === 'all' || article.author === currentAuthor;
      const matchesSearch = !currentSearch ||
        article.title.toLowerCase().includes(currentSearch) ||
        article.excerpt.toLowerCase().includes(currentSearch) ||
        article.category.toLowerCase().includes(currentSearch);
      return matchesAuthor && matchesSearch;
    });

    // Update results info
    if (currentSearch || currentAuthor !== 'all') {
      const authorName = currentAuthor !== 'all'
        ? blogAuthors.find(a => a.slug === currentAuthor)?.name || currentAuthor
        : '';
      let infoText = `Found ${filteredArticles.length} article${filteredArticles.length !== 1 ? 's' : ''}`;
      if (currentSearch) infoText += ` matching "${currentSearch}"`;
      if (authorName) infoText += ` by ${authorName}`;
      resultsInfo.textContent = infoText;
    } else {
      resultsInfo.textContent = `Showing all ${filteredArticles.length} articles`;
    }

    // Reset and render
    displayedCount = 0;
    articlesGrid.innerHTML = '';
    articlesGridContinued.innerHTML = '';
    loadMoreArticles();
  }

  // Load more articles
  function loadMoreArticles() {
    const nextBatch = filteredArticles.slice(displayedCount, displayedCount + ARTICLES_PER_PAGE);

    nextBatch.forEach((article, index) => {
      const globalIndex = displayedCount + index;
      const html = createArticleCard(article);

      // Put first 6 before newsletter, rest after
      if (globalIndex < NEWSLETTER_POSITION) {
        articlesGrid.innerHTML += html;
      } else {
        articlesGridContinued.innerHTML += html;
      }
    });

    displayedCount += nextBatch.length;

    // Update load more button
    const remaining = filteredArticles.length - displayedCount;
    if (remaining > 0) {
      loadMoreWrapper.style.display = 'block';
      loadMoreBtn.textContent = `Load More Articles (${remaining} remaining)`;
    } else {
      loadMoreWrapper.style.display = 'none';
    }
  }

  // Event Listeners
  searchInput.addEventListener('input', (e) => {
    currentSearch = e.target.value.toLowerCase().trim();
    clearBtn.style.display = currentSearch ? 'block' : 'none';
    filterAndRender();
  });

  clearBtn.addEventListener('click', () => {
    searchInput.value = '';
    currentSearch = '';
    clearBtn.style.display = 'none';
    filterAndRender();
  });

  authorFilters.addEventListener('click', (e) => {
    const btn = e.target.closest('.author-btn');
    if (!btn) return;

    // Update active state
    authorFilters.querySelectorAll('.author-btn').forEach(b => b.classList.remove('author-btn--active'));
    btn.classList.add('author-btn--active');

    currentAuthor = btn.dataset.author;
    filterAndRender();
  });

  loadMoreBtn.addEventListener('click', loadMoreArticles);

  // Team card clicks filter by author
  teamCards.forEach(card => {
    card.addEventListener('click', () => {
      const authorSlug = card.dataset.filterAuthor;
      currentAuthor = authorSlug;

      // Update author filter buttons
      authorFilters.querySelectorAll('.author-btn').forEach(b => {
        b.classList.toggle('author-btn--active', b.dataset.author === authorSlug);
      });

      filterAndRender();

      // Scroll to articles
      document.querySelector('.filter-section').scrollIntoView({ behavior: 'smooth' });
    });
  });

  // Newsletter form submission
  newsletterForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = newsletterEmail.value.trim();

    if (!email) return;

    newsletterStatus.textContent = 'Subscribing...';
    newsletterStatus.style.color = '#666';

    try {
      // Send to Google Sheets via Apps Script
      const response = await fetch('https://script.google.com/macros/s/AKfycbzNewsletter/exec', {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, source: 'blog', timestamp: new Date().toISOString() })
      });

      newsletterStatus.textContent = 'âœ“ Subscribed! Check your inbox.';
      newsletterStatus.style.color = '#22c55e';
      newsletterEmail.value = '';
    } catch (error) {
      // Since we're using no-cors, we can't read the response, but assume success
      newsletterStatus.textContent = 'âœ“ Subscribed! Check your inbox.';
      newsletterStatus.style.color = '#22c55e';
      newsletterEmail.value = '';
    }
  });

  // Initial render
  filterAndRender();
</script>

<style>
  /* Hero */
  .blog-hero {
    background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-navy-dark) 100%);
    color: var(--color-white);
    padding: var(--space-12) 0 var(--space-10);
    text-align: center;
  }

  .blog-hero__title {
    color: var(--color-white);
    font-size: var(--text-4xl);
    margin-bottom: var(--space-2);
  }

  .blog-hero__subtitle {
    color: var(--color-gray-300);
    font-size: var(--text-lg);
    margin-bottom: var(--space-8);
  }

  /* Search */
  .search-wrapper {
    max-width: 600px;
    margin: 0 auto;
  }

  .search-box {
    display: flex;
    align-items: center;
    background: var(--color-white);
    border-radius: var(--radius-lg);
    padding: var(--space-2) var(--space-4);
    box-shadow: var(--shadow-lg);
    position: relative;
  }

  .search-icon {
    color: var(--color-gray-400);
    flex-shrink: 0;
    margin-right: var(--space-3);
  }

  .search-input {
    flex: 1;
    border: none;
    padding: var(--space-3) 0;
    font-size: var(--text-base);
    background: transparent;
    outline: none;
  }

  .clear-btn {
    background: none;
    border: none;
    font-size: 24px;
    color: var(--color-gray-400);
    cursor: pointer;
    padding: 0 var(--space-2);
  }

  .clear-btn:hover {
    color: var(--color-gray-600);
  }

  /* Topics Section */
  .topics-section {
    padding: var(--space-12) 0;
    background: var(--color-white);
  }

  .section-title {
    text-align: center;
    margin-bottom: var(--space-8);
    font-size: var(--text-2xl);
  }

  .topics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-6);
  }

  .topic-card {
    background: var(--color-gray-50);
    border: 2px solid var(--color-gray-100);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    text-align: center;
    transition: all var(--transition-base);
  }

  .topic-card:hover {
    border-color: var(--color-gold);
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
  }

  .topic-card__icon {
    font-size: 2.5rem;
    display: block;
    margin-bottom: var(--space-3);
  }

  .topic-card__title {
    font-size: var(--text-lg);
    margin-bottom: var(--space-2);
    color: var(--color-navy);
  }

  .topic-card__desc {
    font-size: var(--text-sm);
    color: var(--color-gray-600);
  }

  /* Filter Section */
  .filter-section {
    background: var(--color-white);
    border-top: 1px solid var(--color-gray-100);
    border-bottom: 1px solid var(--color-gray-100);
    padding: var(--space-4) 0;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .filter-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .filter-label {
    font-weight: var(--font-medium);
    color: var(--color-gray-600);
    white-space: nowrap;
  }

  .author-filters {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .author-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: var(--color-gray-100);
    border: none;
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    color: var(--color-gray-700);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .author-btn:hover {
    background: var(--color-gray-200);
  }

  .author-btn--active {
    background: var(--color-navy);
    color: var(--color-white);
  }

  .author-btn__img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
  }

  .results-info {
    font-size: var(--text-sm);
    color: var(--color-gray-500);
  }

  /* Blog Main */
  .blog-main {
    padding: var(--space-10) 0;
    background: var(--color-gray-50);
  }

  .articles-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-6);
  }

  .articles-grid--continued {
    margin-top: var(--space-6);
  }

  /* Newsletter Inline */
  .newsletter-inline {
    background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-navy-light) 100%);
    border-radius: var(--radius-xl);
    padding: var(--space-10);
    margin: var(--space-10) 0;
    color: var(--color-white);
  }

  .newsletter-inline__content {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
  }

  .newsletter-inline__text h3 {
    color: var(--color-white);
    font-size: var(--text-2xl);
    margin-bottom: var(--space-2);
  }

  .newsletter-inline__text p {
    color: var(--color-gray-300);
    margin-bottom: var(--space-6);
  }

  .newsletter-inline__form {
    display: flex;
    gap: var(--space-3);
    max-width: 450px;
    margin: 0 auto;
  }

  .newsletter-inline__form input {
    flex: 1;
    padding: var(--space-3) var(--space-4);
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--text-base);
  }

  .newsletter-inline__note {
    font-size: var(--text-sm);
    color: var(--color-gray-400);
    margin-top: var(--space-3);
  }

  /* Post Card */
  .post-card {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
    display: flex;
    flex-direction: column;
  }

  .post-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }

  .post-card__image-link {
    display: block;
    aspect-ratio: 16/10;
    overflow: hidden;
  }

  .post-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .post-card:hover .post-card__image {
    transform: scale(1.05);
  }

  .post-card__content {
    padding: var(--space-5);
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .post-card__meta-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
  }

  .post-card__category {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-gold);
  }

  .post-card__date {
    font-size: var(--text-xs);
    color: var(--color-gray-500);
  }

  .post-card__title {
    font-size: var(--text-lg);
    margin-bottom: var(--space-3);
    line-height: 1.3;
    flex: 1;
  }

  .post-card__title a {
    color: var(--color-navy);
    transition: color var(--transition-fast);
  }

  .post-card__title a:hover {
    color: var(--color-gold);
  }

  .post-card__author {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-gray-100);
    margin-top: auto;
  }

  .post-card__author-image {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    object-fit: cover;
  }

  .post-card__author-name {
    font-weight: var(--font-medium);
    color: var(--color-navy);
    font-size: var(--text-sm);
  }

  .post-card__author-creds {
    font-size: var(--text-xs);
    color: var(--color-gray-500);
  }

  /* Load More */
  .load-more-wrapper {
    text-align: center;
    margin-top: var(--space-10);
  }

  /* Team Section */
  .team-section {
    padding: var(--space-12) 0;
    background: var(--color-white);
  }

  .team-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-6);
    max-width: 900px;
    margin: 0 auto;
  }

  .team-card {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--color-gray-50);
    border: 2px solid var(--color-gray-100);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: left;
  }

  .team-card:hover {
    border-color: var(--color-gold);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .team-card__image {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
  }

  .team-card__info {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .team-card__name {
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--color-navy);
  }

  .team-card__creds {
    font-size: var(--text-xs);
    color: var(--color-gold);
  }

  .team-card__count {
    font-size: var(--text-xs);
    color: var(--color-gray-500);
  }

  /* Bottom CTA */
  .bottom-cta {
    background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-navy-dark) 100%);
    padding: var(--space-16) 0;
  }

  .bottom-cta__content {
    text-align: center;
    max-width: 700px;
    margin: 0 auto;
    color: var(--color-white);
  }

  .bottom-cta__badge {
    display: inline-block;
    background: var(--color-gold);
    color: var(--color-navy);
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    margin-bottom: var(--space-4);
  }

  .bottom-cta__content h2 {
    color: var(--color-white);
    margin-bottom: var(--space-4);
  }

  .bottom-cta__content p {
    color: var(--color-gray-300);
    margin-bottom: var(--space-6);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .topics-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .articles-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .team-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .blog-hero__title {
      font-size: var(--text-3xl);
    }

    .topics-grid {
      grid-template-columns: 1fr;
    }

    .filter-bar {
      flex-direction: column;
      align-items: flex-start;
    }

    .author-filters {
      overflow-x: auto;
      width: 100%;
      padding-bottom: var(--space-2);
      flex-wrap: nowrap;
    }

    .articles-grid {
      grid-template-columns: 1fr;
    }

    .newsletter-inline__form {
      flex-direction: column;
    }

    .team-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
